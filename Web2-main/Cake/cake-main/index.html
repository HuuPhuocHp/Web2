<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Cake Template" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cake Shop - Trang Chủ</title>

    <!-- Google Font & CSS -->
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css" />
    <link rel="stylesheet" href="css/flaticon.css" type="text/css" />
    <link rel="stylesheet" href="css/barfiller.css" type="text/css" />
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css" />
    <link rel="stylesheet" href="css/nice-select.css" type="text/css" />
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css" />
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />
  </head>
  <body>
    <!-- Page Preloder -->
    <div id="preloder">
      <div class="loader"></div>
    </div>
    <!-- Header will be injected here -->
    <div id="header-placeholder"></div>

    <!-- Hero Section Begin -->
    <section class="hero">
      <div class="hero__slider owl-carousel">
        <div class="hero__item set-bg" data-setbg="img/hero/hero-1.jpg">
          <div class="container">
            <div class="row d-flex justify-content-center">
              <div class="col-lg-8">
                <div class="hero__text">
                  <h2>
                    Chúng tôi làm cuộc sống của bạn ngọt ngào hơn từng miếng
                    bánh!
                  </h2>
                  <a href="list_product.html" class="primary-btn">Bánh của chúng tôi</a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="hero__item set-bg" data-setbg="img/hero/hero-1.jpg">
          <div class="container">
            <div class="row d-flex justify-content-center">
              <div class="col-lg-8">
                <div class="hero__text">
                  <h2>Những chiếc bánh được làm bằng tình yêu và sự đam mê</h2>
                  <a href="list_product.html" class="primary-btn">Bánh của chúng tôi</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Hero Section End -->

    <!-- About Section Begin -->
    <section class="about spad">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 col-md-6">
            <div class="about__text">
              <div class="section-title">
                <span>Về Cửa Hàng Bánh</span>
                <h2>Bánh và các sản phẩm nướng từ nhà Queens!</h2>
              </div>
              <p>
                "Cake Shop" là một thương hiệu Jordan, bắt đầu là một doanh
                nghiệp gia đình nhỏ. Các chủ sở hữu là Tiến sĩ Iyad Sultan và
                Tiến sĩ Sereen Sharabati, được hỗ trợ bởi đội ngũ 80 nhân viên.
              </p>
            </div>
          </div>
          <div class="col-lg-6 col-md-6">
            <div class="about__bar">
              <div class="about__bar__item">
                <p>Thiết kế bánh</p>
                <div id="bar1" class="barfiller">
                  <span class="fill" data-percentage="95"></span>
                </div>
              </div>
              <div class="about__bar__item">
                <p>Lớp học làm bánh</p>
                <div id="bar2" class="barfiller">
                  <span class="fill" data-percentage="80"></span>
                </div>
              </div>
              <div class="about__bar__item">
                <p>Công thức bánh</p>
                <div id="bar3" class="barfiller">
                  <span class="fill" data-percentage="90"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- About Section End -->

    <!-- Product Section Begin -->
    <section class="product spad">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="section-title">
              <span>Sản Phẩm Nổi Bật</span>
            </div>
            <!-- Slider sẽ được đổ dữ liệu vào đây -->
            <div
              class="product__slider owl-carousel"
              id="featured-products-slider"
            >
              <!-- Sản phẩm nổi bật sẽ được chèn vào đây bởi JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Product Section End -->

    <!-- Testimonial Section Begin -->
    <section class="testimonial spad">
      <div class="container">
        <div class="row">
          <div class="col-lg-12 text-center">
            <div class="section-title">
              <span>Đánh Giá</span>
              <h2>Ý kiến khách hàng</h2>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="testimonial__slider owl-carousel">
            <!-- Các đánh giá giữ nguyên, vì chúng là nội dung tĩnh -->
            <div class="col-lg-6">
              <div class="testimonial__item">
                <div class="testimonial__author">
                  <div class="testimonial__author__pic">
                    <img src="img/testimonial/ta-1.jpg" alt="" />
                  </div>
                  <div class="testimonial__author__text">
                    <h5>Gia Khánh</h5>
                    <span>Quảng Bình</span>
                  </div>
                </div>
                <div class="rating">
                  <span class="icon_star"></span><span class="icon_star"></span
                  ><span class="icon_star"></span><span class="icon_star"></span
                  ><span class="icon_star-half_alt"></span>
                </div>
                <p>
                  Sản phẩm thật sự rất tuyệt vời! Chất lượng vượt trội, thiết kế
                  tinh tế và sử dụng rất dễ dàng.
                </p>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="testimonial__item">
                <div class="testimonial__author">
                  <div class="testimonial__author__pic">
                    <img src="img/testimonial/ta-2.jpg" alt="" />
                  </div>
                  <div class="testimonial__author__text">
                    <h5>Minh Anh</h5>
                    <span>Hà Nội</span>
                  </div>
                </div>
                <div class="rating">
                  <span class="icon_star"></span><span class="icon_star"></span
                  ><span class="icon_star"></span><span class="icon_star"></span
                  ><span class="icon_star"></span>
                </div>
                <p>
                  Tôi đã sử dụng sản phẩm này được vài tuần và nhìn chung là khá
                  hài lòng. Dịch vụ khách hàng rất chu đáo.
                </p>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="testimonial__item">
                <div class="testimonial__author">
                  <div class="testimonial__author__pic">
                    <img src="img/testimonial/ta-1.jpg" alt="" />
                  </div>
                  <div class="testimonial__author__text">
                    <h5>Hoàng Duy</h5>
                    <span>Cali</span>
                  </div>
                </div>
                <div class="rating">
                  <span class="icon_star"></span><span class="icon_star"></span
                  ><span class="icon_star"></span><span class="icon_star"></span
                  ><span class="icon_star-half_alt"></span>
                </div>
                <p>
                  Sản phẩm thực sự đáp ứng đúng kỳ vọng của tôi. Chất lượng tốt,
                  dễ sử dụng và hỗ trợ kỹ thuật rất nhanh chóng.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Testimonial Section End -->

    <!-- Instagram Section Begin -->
    <section class="instagram spad">
      <div class="container">
        <div class="row">
          <div class="col-lg-4 p-0">
            <div class="instagram__text">
              <div class="section-title">
                <span>Theo dõi chúng tôi trên Instagram</span>
                <h2>Những khoảnh khắc ngọt ngào nhất!</h2>
              </div>
              <h5><i class="fa fa-instagram"></i> @sweetcake</h5>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="row">
              <div class="col-lg-4 col-md-4 col-sm-4 col-6">
                <div class="instagram__pic">
                  <img src="img/instagram/instagram-1.jpg" alt="" />
                </div>
              </div>
              <div class="col-lg-4 col-md-4 col-sm-4 col-6">
                <div class="instagram__pic middle__pic">
                  <img src="img/instagram/instagram-2.jpg" alt="" />
                </div>
              </div>
              <div class="col-lg-4 col-md-4 col-sm-4 col-6">
                <div class="instagram__pic">
                  <img src="img/instagram/instagram-3.jpg" alt="" />
                </div>
              </div>
              <div class="col-lg-4 col-md-4 col-sm-4 col-6">
                <div class="instagram__pic">
                  <img src="img/instagram/instagram-4.jpg" alt="" />
                </div>
              </div>
              <div class="col-lg-4 col-md-4 col-sm-4 col-6">
                <div class="instagram__pic middle__pic">
                  <img src="img/instagram/instagram-5.jpg" alt="" />
                </div>
              </div>
              <div class="col-lg-4 col-md-4 col-sm-4 col-6">
                <div class="instagram__pic">
                  <img src="img/instagram/instagram-3.jpg" alt="" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Instagram Section End -->

    <!-- Map Begin -->
    <div class="map">
      <div class="container">
        <div class="row">
          <div class="col-lg-4 col-md-7">
            <div class="map__inner">
              <h6>Cake</h6>
              <ul>
                <li>273 An Dương Vương, Quận 5, TP HCM</li>
                <li>Sweetcake@support.com</li>
                <li>0901641800</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="map__iframe">
        <iframe
          src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d10784.188505644011!2d19.053119335158936!3d47.48899529453826!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sen!2sbd!4v1543907528304"
          height="300"
          style="border: 0"
          allowfullscreen=""
          aria-hidden="false"
          tabindex="0"
        ></iframe>
      </div>
    </div>

    <!-- Map End -->

    <!-- Footer sẽ được tải vào đây -->
  <div id="footer-placeholder"></div>

  <!-- JS Plugins -->
  <!-- Tải jQuery trước, có fallback -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-3.3.1.min.js"><\/script>')</script>

  <!-- Các plugin phụ thuộc jQuery (thứ tự này) -->
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/jquery.nice-select.min.js"></script>
  <script src="js/jquery.slicknav.js"></script>
  <script src="js/jquery.nicescroll.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.barfiller.js"></script>

  <!-- Mã của bạn -->
  <script src="js/main.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/auth.js"></script>
  <!-- TOÀN BỘ LOGIC CỦA TRANG ĐƯỢC ĐẶT Ở ĐÂY -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Fallback: Ẩn preloader an toàn
      const hidePreloader = () => {
        const pre = document.getElementById('preloder');
        const loader = pre ? pre.querySelector('.loader') : null;
        if (loader) loader.style.display = 'none';
        if (pre) pre.style.display = 'none';
      };
      // Nếu có sự cố JS, vẫn ẩn khi window load
      window.addEventListener('load', hidePreloader);

      // --- CÁC HÀM DÙNG CHUNG (TÍCH HỢP) ---
      const includeHTML = (elementId, filePath, callback) => {
        fetch(filePath)
          .then((response) =>
            response.ok ? response.text() : Promise.reject("File not found")
          )
          .then((data) => {
            const element = document.getElementById(elementId);
            if (element) {
              element.innerHTML = data;
            }
            if (callback) callback(); // luôn gọi để không kẹt init
          })
          .catch((error) => {
            console.error(`Lỗi khi tải ${filePath}:`, error);
            if (callback) callback(); // gọi callback cả khi lỗi
          });
      };

      // Update cart count in both header and offcanvas (0 nếu chưa đăng nhập)
      const updateCartCountInHeader = () => {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        let count = 0;
        if (user && window.Cart?.getCart) {
          try { count = (Cart.getCart() || []).reduce((s, it) => s + Number(it.qty ?? it.quantity ?? 1), 0); } catch {}
        }
        const headerCount = document.getElementById('header-cart-count');
        const offcanvasCount = document.getElementById('offcanvas-cart-count');
        if (headerCount) headerCount.textContent = count;
        if (offcanvasCount) offcanvasCount.textContent = count;
      };

      // Update login state for both header and offcanvas menus
      const updateUserStatus = () => {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const headerIn = document.getElementById('header-user-loggedin');
        const headerOut = document.getElementById('header-user-loggedout');
        const offIn = document.getElementById('user-menu-loggedin');
        const offOut = document.getElementById('user-menu-loggedout');
        if (user) {
          if (headerIn && headerOut) {
            headerIn.style.display = 'block';
            headerOut.style.display = 'none';
            const nameEl = document.getElementById('header-fullname-placeholder');
            if (nameEl) nameEl.textContent = user.fullname;
          }
          if (offIn && offOut) {
            offIn.style.display = 'block';
            offOut.style.display = 'none';
            const offName = document.getElementById('user-fullname-placeholder');
            if (offName) offName.textContent = user.fullname;
          }
        } else {
          if (headerIn && headerOut) {
            headerIn.style.display = 'none';
            headerOut.style.display = 'block';
          }
          if (offIn && offOut) {
            offIn.style.display = 'none';
            offOut.style.display = 'block';
          }
        }
      };

      // Initialize UI after header/footer are injected
      const initUI = () => {
        if ($.fn.slicknav && $(".mobile-menu").length && !$("#mobile-menu-wrap .slicknav_menu").length) {
          $(".mobile-menu").slicknav({ prependTo: '#mobile-menu-wrap', allowParentLinks: true });
        }
        $(".canvas__open").off('click').on('click', function () {
          $(".offcanvas-menu-wrapper").addClass("active");
          $(".offcanvas-menu-overlay").addClass("active");
        });
        $(".offcanvas-menu-overlay").off('click').on('click', function () {
          $(".offcanvas-menu-wrapper").removeClass("active");
          $(".offcanvas-menu-overlay").removeClass("active");
        });
        $(".search-switch").off('click').on('click', function () { $(".search-model").fadeIn(400); });
        $(".search-close-switch").off('click').on('click', function () { $(".search-model").fadeOut(400, function () { $('#search-input').val(''); }); });
        $('.set-bg').each(function () { var bg = $(this).data('setbg'); $(this).css('background-image', 'url(' + bg + ')'); });
        updateCartCountInHeader();
        updateUserStatus();

        // Logout được xử lý tập trung trong js/auth.js (delegated [data-logout])
      };

      // Cập nhật tên khi trạng thái đăng nhập thay đổi
      window.addEventListener('authChanged', () => {
        updateUserStatus();
        updateCartCountInHeader();
      });

      // --- LOGIC RIÊNG CỦA TRANG CHỦ ---
      async function renderFeaturedProducts() {
        try {
          // thêm ./ cho chắc đường dẫn tương đối
          const response = await fetch("./database/product.json");
          console.log("renderFeaturedProducts -> status:", response.status);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const allProducts = await response.json();
          console.log("renderFeaturedProducts -> total:", Array.isArray(allProducts) ? allProducts.length : 0);

          const featuredProducts = [...allProducts]
            .sort((a, b) => (b.CountView || 0) - (a.CountView || 0))
            .slice(0, 8);

          if (!featuredProducts.length) {
            document.getElementById("featured-products-slider").innerHTML =
              '<div style="padding:16px">Chưa có sản phẩm nổi bật.</div>';
            return;
          }

          const itemsHTML = featuredProducts.map((product) => {
            const price = Number(product.SellPrice ?? product.Price ?? 0);
            const qty = Number(product.Avaiable_quantity ?? product.Available_quantity ?? product.Quantity ?? 0);
            const isHot = (product.CountView || 0) > 20;
            const img = product.Image || "img/product/default.jpg";
            return `
              <div class="product__item">
                <div class="product__item__pic set-bg" data-setbg="${img}"></div>
                <div class="product__item__text">
                  <h6>
                    <a href="product_detail.html?id=${product.ProductId}">${product.Name}</a>
                    ${isHot ? '<span style="color: red; font-size: 0.8em; margin-left: 5px;"><i class="fa fa-fire"></i> Hot</span>' : ""}
                  </h6>
                  <h5>${price.toLocaleString("vi-VN")} VND</h5>
                  <div>
                    ${qty > 0
                      ? `<button class="btn primary-btn btn-sm mt-2" onclick="handleAddToCart(${product.ProductId})">Thêm giỏ hàng</button>`
                      : '<span style="color: red; font-weight: bold;">Hết hàng</span>'}
                  </div>
                </div>
              </div>`;
          }).join("");

          initOrUpdateProductSlider(itemsHTML);
        } catch (error) {
          console.error("Lỗi khi tải sản phẩm nổi bật:", error);
          document.getElementById("featured-products-slider").innerHTML =
            '<div style="padding:16px;color:#c00">Không tải được dữ liệu sản phẩm.</div>';
        }
      }

      // Khởi tạo hoặc cập nhật Owl Carousel cho slider sản phẩm
      function initOrUpdateProductSlider(itemsHTML) {
        const $slider = $(".product__slider");
        const container = document.getElementById("featured-products-slider");
        if (!$slider.length) {
          console.warn("Thiếu .product__slider");
          return;
        }

        // Nếu Owl chưa có (plugin chưa load), render dạng lưới để nhìn thấy dữ liệu
        if (typeof $.fn.owlCarousel !== "function") {
          console.warn("Owl Carousel chưa sẵn sàng, hiển thị dạng lưới tạm thời.");
          container.innerHTML = itemsHTML;
          applySetBg();
          return;
        }

        // Đã khởi tạo rồi -> thay nội dung bằng chuỗi HTML (KHÔNG dùng $(itemsHTML))
        if ($slider.hasClass("owl-loaded")) {
          $slider.trigger("replace.owl.carousel", [itemsHTML]).trigger("refresh.owl.carousel");
        } else {
          // Chưa khởi tạo -> gán HTML rồi init
          container.innerHTML = itemsHTML;
          // đợi 1 tick để DOM cập nhật rồi init Owl
          setTimeout(() => {
            $slider.owlCarousel({
              loop: true, margin: 0, items: 4, dots: false, nav: true,
              navText: ["<span class='arrow_left'><span/>","<span class='arrow_right'><span/>"],
              smartSpeed: 1200, autoHeight: false, autoplay: false,
              responsive: { 0:{items:1}, 480:{items:2}, 768:{items:3}, 992:{items:4} },
            });
          }, 0);
        }

        applySetBg();
      }

      function applySetBg() {
        $(".set-bg").each(function () {
          const bg = $(this).data("setbg");
          if (bg) $(this).css("background-image", "url(" + bg + ")");
        });
      }

      // --- KHỞI TẠO VÀ CHẠY CHƯƠNG TRÌNH ---
      let loaded = 0;
      const afterInclude = () => {
        loaded++;
        if (loaded === 2) {
          initUI();
          // Gọi luôn để chắc hero/testimonial hoạt động
          if (typeof initializePlugins === "function") initializePlugins();
        }
      };
      includeHTML("header-placeholder", "inc/header.html", afterInclude);
      includeHTML("footer-placeholder", "inc/footer.html", afterInclude);

      // Tải và hiển thị sản phẩm nổi bật + ẩn preloader trong mọi trường hợp
      try {
        await renderFeaturedProducts();
      } catch (e) {
        console.error("Lỗi khi hiển thị sản phẩm nổi bật:", e);
      } finally {
        hidePreloader();
      }

      window.addEventListener("cartUpdated", updateCartCountInHeader);
    });
  </script>
  </body>
</html>
