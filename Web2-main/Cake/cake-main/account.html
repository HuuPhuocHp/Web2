<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tài khoản của tôi</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css" />
  <link rel="stylesheet" href="css/elegant-icons.css" type="text/css" />
  <link rel="stylesheet" href="css/flaticon.css" type="text/css" />
  <link rel="stylesheet" href="css/barfiller.css" type="text/css" />
  <link rel="stylesheet" href="css/magnific-popup.css" type="text/css" />
  <link rel="stylesheet" href="css/nice-select.css" type="text/css" />
  <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css" />
  <link rel="stylesheet" href="css/slicknav.min.css" type="text/css" />
  <link rel="stylesheet" href="css/style.css" type="text/css" />
  <style>
    main.page { min-height: 60vh; }
    .account-card { border: 1px solid #eee; border-radius: 6px; padding: 20px; }
    .account-card h5 { margin-bottom: 16px; }
  </style>
</head>
<body>
  <div id="preloder"><div class="loader"></div></div>

  <!-- Header -->
  <div id="header-placeholder"></div>

  <main class="page">
    <div class="breadcrumb-option">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 col-md-6 col-sm-6"><div class="breadcrumb__text"><h2>Tài khoản</h2></div></div>
          <div class="col-lg-6 col-md-6 col-sm-6">
            <div class="breadcrumb__links"><a href="./index.html">Trang chủ</a><span>Tài khoản</span></div>
          </div>
        </div>
      </div>
    </div>

    <section class="shop spad">
      <div class="container">
        <!-- Yêu cầu đăng nhập -->
        <div id="login-required" class="alert alert-danger text-center" style="display:none;">
          <strong>Vui lòng đăng nhập để quản lý tài khoản.</strong><br/><br/>
          <a class="primary-btn" href="login.html?return=account.html">Đến trang đăng nhập</a>
        </div>

        <!-- Nội dung khi đã đăng nhập -->
        <div id="account-wrapper" style="display:none;">
          <div class="row justify-content-center">
            <div class="col-lg-8">
              <div class="account-card">
                <h5>Thông tin cá nhân</h5>
                <form id="account-form" novalidate>
                  <div class="form-group">
                    <label for="full_name">Họ và tên</label>
                    <input type="text" class="form-control" id="full_name" name="full_name" placeholder="Nguyễn Văn A" required>
                  </div>
                  <div class="form-group">
                    <label for="email">Email (không thể thay đổi)</label>
                    <input type="email" class="form-control" id="email" name="email" readonly>
                  </div>
                  <div class="form-group">
                    <label for="number_phone">Số điện thoại</label>
                    <input type="tel" class="form-control" id="number_phone" name="number_phone" placeholder="0123456789" pattern="^[0-9]{9,11}$">
                    <small class="form-text text-muted">9-11 chữ số.</small>
                  </div>
                  <div class="form-group">
                    <label for="address">Địa chỉ</label>
                    <input type="text" class="form-control" id="address" name="address" placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành phố">
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn primary-btn">Lưu thay đổi</button>
                    <button type="button" id="btn-cancel" class="btn btn-secondary ml-2">Hủy</button>
                  </div>
                </form>
                <div id="account-message" class="mt-3" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-3.3.1.min.js"><\/script>')</script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/jquery.nice-select.min.js"></script>
  <script src="js/jquery.slicknav.js"></script>
  <script src="js/jquery.nicescroll.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.barfiller.js"></script>

  <script src="js/main.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/auth.js"></script>

  <script>
    // Include header/footer helpers
    function applySetBg(){ $(".set-bg").each(function(){ const bg=$(this).data("setbg"); if(bg)$(this).css("background-image","url("+bg+")"); }); }
    function include(id, file, cb){
      fetch(file).then(r=>r.ok?r.text():Promise.reject(file))
        .then(html=>{ const el=document.getElementById(id); if(el) el.innerHTML=html; applySetBg(); cb&&cb(); })
        .catch(e=>{ console.error("Include lỗi:", e); cb&&cb(); });
    }

    // Header UI helpers
    function updateHeader(){
      const user = JSON.parse(localStorage.getItem('user')||'null');
      const inEl=document.getElementById('header-user-loggedin');
      const outEl=document.getElementById('header-user-loggedout');
      const nameEl=document.getElementById('header-fullname-placeholder');
      if(user){ inEl&&(inEl.style.display='inline-flex'); outEl&&(outEl.style.display='none'); nameEl&&(nameEl.textContent=user.fullname||user.email); }
      else { inEl&&(inEl.style.display='none'); outEl&&(outEl.style.display='inline'); }
      let c=0; if(user&&window.Cart?.getCart){ try{ c=(Cart.getCart()||[]).reduce((s,it)=>s+Number(it.qty??it.quantity??1),0);}catch{} }
      const head=document.getElementById('header-cart-count'); const off=document.getElementById('offcanvas-cart-count'); head&&(head.textContent=c); off&&(off.textContent=c);
    }

    // Guard + load form
    function guard(){
      const u = JSON.parse(localStorage.getItem('user')||'null');
      const need = document.getElementById('login-required');
      const ok = document.getElementById('account-wrapper');
      if(u){ need.style.display='none'; ok.style.display='block'; } else { need.style.display='block'; ok.style.display='none'; }
      return !!u;
    }
    function loadForm(){
      const u = JSON.parse(localStorage.getItem('user')||'null');
      if(!u) return;
      document.getElementById('full_name').value = u.fullname || '';
      document.getElementById('email').value = u.email || '';
      document.getElementById('number_phone').value = u.number_phone || u.phone || '';
      document.getElementById('address').value = u.address || '';
    }

    function saveUserToUsersList(updated){
      try{
        const raw = localStorage.getItem('users');
        if(!raw) return;
        const arr = JSON.parse(raw || '[]');
        const idx = arr.findIndex(x => (x.id ?? x.userId) === updated.id || x.email === updated.email);
        if(idx >= 0){ arr[idx] = {...arr[idx], ...updated}; localStorage.setItem('users', JSON.stringify(arr)); }
      }catch{}
    }

    function showMsg(type, text){
      const el = document.getElementById('account-message');
      if(!el) return;
      el.className = 'mt-3 alert ' + (type === 'success' ? 'alert-success' : 'alert-danger');
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, 2500);
    }

    // Preloader
    const hidePreloader=()=>{const pre=document.getElementById('preloder'); if(pre) pre.style.display='none';};
    window.addEventListener('load', hidePreloader);

    document.addEventListener('DOMContentLoaded', async ()=>{
      await new Promise(res=>include('header-placeholder','inc/header.html',res));
      include('footer-placeholder','inc/footer.html');

      updateHeader();
      window.addEventListener('authChanged', updateHeader);
      window.addEventListener('cartUpdated', updateHeader);

      if(!guard()) return;
      loadForm();

      // Submit
      document.getElementById('account-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const user = JSON.parse(localStorage.getItem('user')||'null');
        if(!user){ location.href='login.html?return=account.html'; return; }

        const full_name = document.getElementById('full_name').value.trim();
        const number_phone = document.getElementById('number_phone').value.trim();
        const address = document.getElementById('address').value.trim();

        if(!full_name){ showMsg('error','Vui lòng nhập họ và tên.'); return; }
        if(number_phone && !/^[0-9]{9,11}$/.test(number_phone)){ showMsg('error','Số điện thoại không hợp lệ.'); return; }

        const updated = { ...user, fullname: full_name, number_phone, address };
        localStorage.setItem('user', JSON.stringify(updated));
        saveUserToUsersList(updated);

        // Thông báo cho header/offcanvas cập nhật tên hiển thị
        window.dispatchEvent(new Event('authChanged'));

        showMsg('success','Đã lưu thay đổi.');
      });

      document.getElementById('btn-cancel').addEventListener('click', ()=>{
        loadForm();
      });
    });
  </script>
</body>
</html>