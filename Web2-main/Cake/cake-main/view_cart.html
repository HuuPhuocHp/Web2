<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Cake Template" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giỏ Hàng Của Bạn</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css" />
    <link rel="stylesheet" href="css/flaticon.css" type="text/css" />
    <link rel="stylesheet" href="css/barfiller.css" type="text/css" />
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css" />
    <link rel="stylesheet" href="css/nice-select.css" type="text/css" />
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css" />
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />
  </head>
  <style>
    /* Đổi màu header của bảng giỏ hàng */
    .table thead tr th {
      background-color: #f08632; /* cam */
      color: #fff; /* chữ trắng */
      text-align: center; /* căn giữa nếu muốn */
      border-color: #f08632; /* viền cùng màu cam */
    }
  </style>
  <body>
    <div id="preloder"><div class="loader"></div></div>

    <!-- HEADER -->
    <div id="header-placeholder"></div>

    <!-- Guard: yêu cầu đăng nhập trước khi xem giỏ hàng -->
    <script>
      (function () {
        try {
          var user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user) {
            var returnUrl = "view_cart.html";
            location.href =
              "login.html?return=" + encodeURIComponent(returnUrl);
          }
        } catch (e) {
          location.href =
            "login.html?return=" + encodeURIComponent("view_cart.html");
        }
      })();
    </script>

    <!-- Nội dung giỏ hàng của bạn -->
    <main class="page">
      <div class="breadcrumb-option">
        <div class="container">
          <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">
              <div class="breadcrumb__text"><h2>Giỏ Hàng</h2></div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-6">
              <div class="breadcrumb__links">
                <a href="./index.html">Trang chủ</a>
                <span>Giỏ Hàng</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <section class="shop spad">
        <div class="container">
          <div class="row">
            <div class="col-lg-12">
              <div class="table-responsive text-nowrap">
                <table class="table">
                  <thead>
                    <tr>
                      <th>STT</th>
                      <th>Tên sản phẩm</th>
                      <th>Hình ảnh</th>
                      <th>Số lượng</th>
                      <th>Đơn giá</th>
                      <th>Thành tiền</th>
                      <th>Xóa</th>
                    </tr>
                  </thead>
                  <tbody id="cart-tbody">
                    <!-- JS sẽ lấp dữ liệu -->
                  </tbody>
                </table>

                <div class="cart__total">
                  <strong>Tổng tiền:</strong>
                  <span id="cart-total-amount" class="cart-total-red">0 VND</span>
                </div>

                <!-- THÊM CỤM NÚT HÀNH ĐỘNG -->
                <div class="cart__actions">
                  <a
                    href="list_product.html"
                    class="site-btn"
                    id="btn-continue"
                    style="background-color: #f08632; color: white"
                  >
                    Tiếp tục mua
                  </a>

                  <button
                    class="site-btn"
                    id="btn-go-checkout"
                    style="background-color: #f08632; color: white"
                  >
                    Tiến hành thanh toán
                  </button>
                </div>

                <div
                  class="alert alert-warning"
                  id="empty-cart-message"
                  style="display: none; text-align: center"
                >
                  Giỏ hàng của bạn đang trống.
                  <a href="index.html">Quay lại mua sắm</a>.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <div id="footer-placeholder"></div>

    <!-- JS giống các trang khác -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      window.jQuery ||
        document.write('<script src="js/jquery-3.3.1.min.js"><\/script>');
    </script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/jquery.nicescroll.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.barfiller.js"></script>
    <script src="js/main.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/auth.js"></script>
    <script>
      // Gộp cart_guest -> cart_{userId} nếu vừa đăng nhập
      (function ensureMergedGuestCart() {
        try {
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user) return;
          const guest = JSON.parse(localStorage.getItem("cart_guest") || "[]");
          const key = "cart_" + user.id;
          if (guest.length) {
            const curr = JSON.parse(localStorage.getItem(key) || "[]");
            const map = new Map();
            [...curr, ...guest].forEach((it) => {
              const id = Number(it.productId ?? it.ProductId ?? it.id);
              const qty = Number(it.qty ?? it.quantity ?? 1);
              if (!map.has(id)) map.set(id, { productId: id, qty: 0 });
              map.get(id).qty += qty;
            });
            localStorage.setItem(key, JSON.stringify([...map.values()]));
            localStorage.removeItem("cart_guest");
          }
        } catch {}
      })();

      const fmt = (n) => (Number(n) || 0).toLocaleString("vi-VN") + " VND";
      async function getProductMap() {
        try {
          const res = await fetch("./database/product.json");
          const arr = await res.json();
          return Object.fromEntries(arr.map((p) => [Number(p.ProductId), p]));
        } catch (e) {
          console.error("Không tải được product.json", e);
          return {};
        }
      }

      async function renderCart() {
        const tbody = document.getElementById("cart-tbody");
        const totalEl = document.getElementById("cart-total-amount");
        if (!tbody) return;

        const items = (window.Cart && Cart.getCart && Cart.getCart()) || [];
        const emptyMsg = document.getElementById("empty-cart-message");
        const checkoutBtn = document.getElementById("btn-go-checkout");
        if (!items.length) {
          tbody.innerHTML = "";
          if (totalEl) totalEl.textContent = fmt(0);
          if (emptyMsg) emptyMsg.style.display = "block";
          if (checkoutBtn) checkoutBtn.disabled = true;
          return;
        } else {
          if (emptyMsg) emptyMsg.style.display = "none";
          if (checkoutBtn) checkoutBtn.disabled = false;
        }

        const pmap = await getProductMap();
        let total = 0;

        tbody.innerHTML = items
          .map((it, idx) => {
            const pid = Number(it.productId ?? it.ProductId ?? it.id);
            const qty = Number(it.qty ?? it.quantity ?? 1);
            const p = pmap[pid];
            const name = p ? p.Name : "SP #" + pid;
            const price = p ? Number(p.SellPrice ?? p.Price ?? 0) : 0;
            const img = p?.Image || "img/placeholder.png";
            const sub = price * qty;
            total += sub;
            return `
          <tr data-id="${pid}">
            <td>${idx + 1}</td>
            <td>${name}</td>
            <td><img src="${img}" alt="${name}" style="width:70px;height:auto"/></td>
            <td>
              <input type="number" min="1" value="${qty}" class="cart-qty" style="width:70px" />
            </td>
            <td>${fmt(price)}</td>
            <td class="cart-subtotal">${fmt(sub)}</td>
            <td><button class="btn btn-sm btn-outline-danger cart-remove">Xóa</button></td>
          </tr>
        `;
          })
          .join("");

        if (totalEl) totalEl.textContent = fmt(total);

        // Sự kiện: đổi số lượng
        tbody.querySelectorAll(".cart-qty").forEach((inp) => {
          inp.addEventListener("change", (e) => {
            const tr = e.target.closest("tr");
            const pid = Number(tr.dataset.id);
            let qty = Math.max(1, Number(e.target.value) || 1);
            // cập nhật vào Cart
            const arr = Cart.getCart().map((x) =>
              Number(x.productId) === pid ? { ...x, qty } : x
            );
            Cart.setCart(arr);
            renderCart();
          });
        });
        // Sự kiện: xóa
        tbody.querySelectorAll(".cart-remove").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const tr = e.target.closest("tr");
            const pid = Number(tr.dataset.id);
            Cart.removeFromCart
              ? Cart.removeFromCart(pid)
              : Cart.setCart(
                  Cart.getCart().filter((x) => Number(x.productId) !== pid)
                );
            renderCart();
          });
        });
      }

      // Nút thanh toán
      document
        .getElementById("btn-go-checkout")
        ?.addEventListener("click", (e) => {
          e.preventDefault();
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!Cart.getCart().length) {
            alert("Giỏ hàng trống");
            return;
          }
          if (!user) {
            window.location.href = "login.html?return=user_order.html";
            return;
          }
          window.location.href = "user_order.html";
        });

      // Đồng bộ header/footer và render giỏ
      function applySetBg() {
        $(".set-bg").each(function () {
          const bg = $(this).data("setbg");
          if (bg) $(this).css("background-image", "url(" + bg + ")");
        });
      }
      function include(id, file, cb) {
        fetch(file)
          .then((r) => (r.ok ? r.text() : Promise.reject(file)))
          .then((html) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = html;
            applySetBg();
            cb && cb();
          })
          .catch((err) => console.error("Include lỗi:", err));
      }
      function updateHeader() {
        const user = JSON.parse(localStorage.getItem("user") || "null");
        const inEl = document.getElementById("header-user-loggedin");
        const outEl = document.getElementById("header-user-loggedout");
        const nameEl = document.getElementById("header-fullname-placeholder");
        if (user) {
          inEl && (inEl.style.display = "inline-flex");
          outEl && (outEl.style.display = "none");
          nameEl && (nameEl.textContent = user.fullname || user.email);
        } else {
          inEl && (inEl.style.display = "none");
          outEl && (outEl.style.display = "inline");
        }
        let c = 0;
        if (user && Cart.getCart) {
          try {
            c = (Cart.getCart() || []).reduce(
              (s, it) => s + Number(it.qty ?? it.quantity ?? 1),
              0
            );
          } catch {}
        }
        document.getElementById("header-cart-count") &&
          (document.getElementById("header-cart-count").textContent = c);
        document.getElementById("offcanvas-cart-count") &&
          (document.getElementById("offcanvas-cart-count").textContent = c);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await new Promise((res) =>
          include("header-placeholder", "inc/header.html", res)
        );
        include("footer-placeholder", "inc/footer.html");
        updateHeader();
        renderCart();
        window.addEventListener("authChanged", () => {
          updateHeader();
          renderCart();
        });
        window.addEventListener("cartUpdated", () => {
          updateHeader();
          renderCart();
        });
      });

      // Preloader
      window.addEventListener("load", () => {
        const pre = document.getElementById("preloder");
        if (pre) pre.style.display = "none";
      });
    </script>

    <!-- Có thể để cuối file, sau các script đã có -->
    <style>
      .cart__actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 16px;
      }
      .cart__actions .site-btn {
        min-width: 220px;
      }
      /* Tổng tiền màu đỏ giống user_order screenshot */
      .cart-total-red { color: #e40000; font-weight: 700; }
      /* Thanh nền nhạt phía dưới tổng tiền giống mockup */
      .cart__total { background: #fff6f0; padding: 14px 16px; margin-top: 12px; border-radius: 4px; }
    </style>

    <script>
      // Gắn sự kiện cho nút thanh toán
      document
        .getElementById("btn-go-checkout")
        ?.addEventListener("click", (e) => {
          e.preventDefault();
          const items = (window.Cart && Cart.getCart && Cart.getCart()) || [];
          if (!items.length) {
            alert("Giỏ hàng trống");
            return;
          }
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user) {
            // Chưa đăng nhập -> yêu cầu đăng nhập rồi quay về trang đặt hàng
            window.location.href = "login.html?return=user_order.html";
            return;
          }
          // Đã đăng nhập -> sang trang điền thông tin và đặt hàng
          window.location.href = "user_order.html";
        });

      // Tùy chọn: disable nút nếu giỏ trống khi render
      function toggleCheckoutBtn() {
        const btn = document.getElementById("btn-go-checkout");
        if (!btn || !window.Cart?.getCart) return;
        const disabled = Cart.getCart().length === 0;
        btn.disabled = disabled;
        btn.classList.toggle("disabled", disabled);
      }
      document.addEventListener("DOMContentLoaded", toggleCheckoutBtn);
      window.addEventListener("cartUpdated", toggleCheckoutBtn);
    </script>
  </body>
</html>
