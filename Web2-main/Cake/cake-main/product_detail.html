<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Cake Template">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Sản Phẩm</title>

    <!-- Google Font & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="css/flaticon.css" type="text/css">
    <link rel="stylesheet" href="css/barfiller.css" type="text/css">
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">
</head>
<body>
    <!-- Header sẽ được tải vào đây -->
    <div id="header-placeholder"></div>

    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="breadcrumb__text">
                        <h2>Chi Tiết Sản Phẩm</h2>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="breadcrumb__links">
                        <a href="./index.html">Trang chủ</a>
                        <a href="./list_product.html">Cửa hàng</a>
                        <span id="breadcrumb-product-name">Tên sản phẩm</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Product Details Section Begin -->
    <section class="product-details spad">
        <div class="container">
            <div class="row" id="product-detail-content">
                <!-- Nội dung chi tiết sản phẩm sẽ được chèn vào đây -->
                <div class="col-12 text-center"><p>Đang tải thông tin sản phẩm...</p></div>
            </div>
        </div>
    </section>
    <!-- Product Details Section End -->

    <!-- Related Products Section Begin -->
    <section class="related-products spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="section-title">
                        <h2>Sản phẩm tương tự</h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="related__products__slider owl-carousel" id="related-products-slider">
                    <!-- Sản phẩm tương tự sẽ được chèn vào đây -->
                </div>
            </div>
        </div>
    </section>
    <!-- Related Products Section End -->

    <!-- Footer sẽ được tải vào đây -->
    <div id="footer-placeholder"></div>

    <!-- JS -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/jquery.nicescroll.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.barfiller.js"></script>
    <script src="js/main.js"></script>
    <script src="js/cart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- CÁC HÀM DÙNG CHUNG (TÍCH HỢP) ---
            const includeHTML = (elementId, filePath, callback) => {
                fetch(filePath)
                    .then(response => response.ok ? response.text() : Promise.reject('File not found'))
                    .then(data => {
                        const element = document.getElementById(elementId);
                        if (element) { element.innerHTML = data; if (callback) callback(); }
                    })
                    .catch(error => console.error(`Lỗi khi tải ${filePath}:`, error));
            };

                        const updateCartCountInHeader = () => {
                                const user = JSON.parse(localStorage.getItem('user') || 'null');
                                let count = 0;
                                if (user && window.Cart?.getCart) {
                                    try { count = (Cart.getCart() || []).reduce((s, it) => s + Number(it.qty ?? it.quantity ?? 1), 0); } catch {}
                                }
                                const headerCount = document.getElementById('header-cart-count');
                                const offcanvasCount = document.getElementById('offcanvas-cart-count');
                                if (headerCount) headerCount.textContent = count;
                                if (offcanvasCount) offcanvasCount.textContent = count;
                        };

            const updateUserStatus = () => {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                const headerIn = document.getElementById('header-user-loggedin');
                const headerOut = document.getElementById('header-user-loggedout');
                const offIn = document.getElementById('user-menu-loggedin');
                const offOut = document.getElementById('user-menu-loggedout');
                if (user) {
                    if (headerIn && headerOut) {
                        headerIn.style.display = 'block';
                        headerOut.style.display = 'none';
                        const nameEl = document.getElementById('header-fullname-placeholder');
                        if (nameEl) nameEl.textContent = user.fullname;
                    }
                    if (offIn && offOut) {
                        offIn.style.display = 'block';
                        offOut.style.display = 'none';
                        const offName = document.getElementById('user-fullname-placeholder');
                        if (offName) offName.textContent = user.fullname;
                    }
                } else {
                    if (headerIn && headerOut) {
                        headerIn.style.display = 'none';
                        headerOut.style.display = 'block';
                    }
                    if (offIn && offOut) {
                        offIn.style.display = 'none';
                        offOut.style.display = 'block';
                    }
                }
            };

            // --- LOGIC RIÊNG CỦA TRANG CHI TIẾT SẢN PHẨM ---

            // Hàm mới để xử lý việc thêm vào giỏ hàng với số lượng tùy chỉnh
            window.handleAddToCartWithQuantity = async (productId) => {
                const quantityInput = document.getElementById('quantity-input');
                const quantity = parseInt(quantityInput.value);
                
                if (isNaN(quantity) || quantity < 1) {
                    notify("Số lượng không hợp lệ.", "error");
                    return;
                }
                
                // Sử dụng lại hàm handleAddToCart đã có trong cart.js (nếu có)
                // Hoặc gọi trực tiếp Cart.add
                await Cart.add(productId, quantity);
            };

            async function initProductPage() {
                const params = new URLSearchParams(window.location.search);
                const productId = params.get('id');
                const contentDiv = document.getElementById('product-detail-content');

                if (!productId) {
                    contentDiv.innerHTML = '<div class="col-12"><p class="text-danger">Lỗi: Không tìm thấy ID sản phẩm.</p></div>';
                    return;
                }

                try {
                    // Lấy dữ liệu từ file product.json trong thư mục data
                    const response = await fetch('database/product.json');
                    const allProducts = await response.json();
                    const product = allProducts.find(p => p.ProductId == productId);

                    if (!product) {
                        contentDiv.innerHTML = '<div class="col-12"><p class="text-danger">Không tìm thấy sản phẩm.</p></div>';
                        return;
                    }
                    
                    // Cập nhật Breadcrumb
                    document.title = product.Name;
                    document.getElementById('breadcrumb-product-name').textContent = product.Name;

                    // Hiển thị chi tiết sản phẩm
                    contentDiv.innerHTML = `
                        <div class="col-lg-6">
                            <div class="product__details__img">
                                <div class="product__details__big__img">
                                    <img class="big_img" src="${product.Image}" alt="${product.Name}">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="product__details__text">
                                <h4>${product.Name}</h4>
                                <h5>${product.SellPrice.toLocaleString('vi-VN')} VND</h5>
                                <p>${product.Description || 'Chưa có mô tả cho sản phẩm này.'}</p>
                                <ul>
                                    <li>Số lượng còn lại: <span>${product.Avaiable_quantity}</span></li>
                                    <li>Loại bánh: <span>${product.CategoryName}</span></li>
                                    <li>Thương hiệu: <span>${product.BrandName || 'N/A'}</span></li>
                                </ul>
                                <div class="product__details__option">
                                    ${product.Avaiable_quantity > 0 ? `
                                        <div class="quantity">
                                            <div class="pro-qty">
                                                <input id="quantity-input" type="number" value="1" min="1" max="${product.Avaiable_quantity}">
                                            </div>
                                        </div>
                                        <button type="button" class="primary-btn" onclick="handleAddToCartWithQuantity(${product.ProductId})">THÊM VÀO GIỎ</button>
                                    ` : `
                                        <span style="color: red; font-weight: bold; font-size: 1.5rem;">HẾT HÀNG</span>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;

                    // Hiển thị sản phẩm tương tự
                    const relatedSlider = document.getElementById('related-products-slider');
                    const relatedProducts = allProducts.filter(p => p.CategoryId === product.CategoryId && p.ProductId !== product.ProductId).slice(0, 4);

                    relatedSlider.innerHTML = '';
                    relatedProducts.forEach(relProd => {
                        relatedSlider.innerHTML += `
                            <div class="col-lg-3">
                                <div class="product__item">
                                    <div class="product__item__pic set-bg" data-setbg="${relProd.Image}"></div>
                                    <div class="product__item__text">
                                        <h6><a href="product_detail.html?id=${relProd.ProductId}">${relProd.Name}</a></h6>
                                        <h5>${relProd.SellPrice.toLocaleString('vi-VN')} VND</h5>
                                        ${relProd.Avaiable_quantity > 0 
                                            ? `<button class="btn primary-btn btn-sm mt-2" onclick="handleAddToCart(${relProd.ProductId})">Thêm giỏ hàng</button>`
                                            : '<span style="color: red; font-weight:bold;">Hết hàng</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    // Khởi tạo lại Owl Carousel và các plugin khác
                    $('.related__products__slider').owlCarousel({
                        loop: false, margin: 0, items: 4, dots: false, nav: true,
                        navText: ["<span class='arrow_left'><span/>", "<span class='arrow_right'><span/>"],
                        smartSpeed: 1200, autoHeight: false, autoplay: false
                    });
                    $('.set-bg').each(function () {
                        var bg = $(this).data('setbg');
                        $(this).css('background-image', 'url(' + bg + ')');
                    });
                     // Khởi tạo pro-qty (nếu có)
                    var proQty = $('.pro-qty');
                    proQty.prepend('<span class="dec qtybtn">-</span>');
                    proQty.append('<span class="inc qtybtn">+</span>');
                    proQty.on('click', '.qtybtn', function () {
                        var $button = $(this);
                        var oldValue = $button.parent().find('input').val();
                        var newVal;
                        if ($button.hasClass('inc')) {
                            newVal = parseFloat(oldValue) + 1;
                        } else {
                            if (oldValue > 1) {
                                newVal = parseFloat(oldValue) - 1;
                            } else {
                                newVal = 1;
                            }
                        }
                        $button.parent().find('input').val(newVal);
                    });

                } catch (error) {
                    console.error("Lỗi khi xử lý trang sản phẩm:", error);
                    contentDiv.innerHTML = '<div class="col-12"><p class="text-danger">Đã xảy ra lỗi khi tải thông tin sản phẩm.</p></div>';
                }
            }

            // --- KHỞI TẠO VÀ CHẠY CHƯƠNG TRÌNH ---
            const initUI = () => {
                if ($.fn.slicknav && $(".mobile-menu").length && !$("#mobile-menu-wrap .slicknav_menu").length) {
                    $(".mobile-menu").slicknav({ prependTo: '#mobile-menu-wrap', allowParentLinks: true });
                }
                $(".canvas__open").off('click').on('click', function () { $(".offcanvas-menu-wrapper").addClass("active"); $(".offcanvas-menu-overlay").addClass("active"); });
                $(".offcanvas-menu-overlay").off('click').on('click', function () { $(".offcanvas-menu-wrapper").removeClass("active"); $(".offcanvas-menu-overlay").removeClass("active"); });
                $(".search-switch").off('click').on('click', function () { $(".search-model").fadeIn(400); });
                $(".search-close-switch").off('click').on('click', function () { $(".search-model").fadeOut(400, function () { $('#search-input').val(''); }); });
                $('.set-bg').each(function () { var bg = $(this).data('setbg'); $(this).css('background-image', 'url(' + bg + ')'); });
                updateUserStatus();
                updateCartCountInHeader();
            };
            let loaded = 0; const afterInclude = () => { loaded++; if (loaded === 2) initUI(); };
            includeHTML('header-placeholder', 'inc/header.html', afterInclude);
            includeHTML('footer-placeholder', 'inc/footer.html', afterInclude);

            initProductPage();

            window.addEventListener('cartUpdated', updateCartCountInHeader);
        });
    </script>
</body>
</html>
