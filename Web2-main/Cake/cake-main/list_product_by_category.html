<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Cake Template">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sản Phẩm Theo Loại</title>

    <!-- Google Font & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="css/flaticon.css" type="text/css">
    <link rel="stylesheet" href="css/barfiller.css" type="text/css">
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="breadcrumb__text">
                        <h2 id="category-title">Cửa Hàng</h2>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="breadcrumb__links">
                        <a href="./index.html">Trang chủ</a>
                        <a href="./list_product.html">Cửa hàng</a>
                        <span id="breadcrumb-category-name">Loại bánh</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <section class="shop spad">
        <div class="container">
             <div class="shop__option">
                <div class="row">
                    <div class="col-lg-7 col-md-7">
                        <div class="shop__option__search">
                           <!-- Dropdown để chuyển loại bánh -->
                           <select id="category-selector" class="custom-select" style="width: auto;">
                                <!-- Các loại bánh sẽ được chèn vào đây -->
                           </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Lưới sản phẩm -->
            <div class="row" id="product-grid">
                <!-- Sản phẩm sẽ được chèn vào đây -->
            </div>
            <!-- Phân trang -->
            <div class="shop__last__option">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="shop__pagination" id="pagination-container">
                            <!-- Các nút phân trang sẽ được chèn vào đây -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="footer-placeholder"></div>

    <!-- JS -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/jquery.nicescroll.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.barfiller.js"></script>
    <script src="js/main.js"></script>
    <script src="js/cart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- CÁC HÀM DÙNG CHUNG (TÍCH HỢP) ---
            const includeHTML = (elementId, filePath, callback) => {
                fetch(filePath)
                    .then(response => response.ok ? response.text() : Promise.reject('File not found'))
                    .then(data => {
                        const element = document.getElementById(elementId);
                        if (element) { element.innerHTML = data; if (callback) callback(); }
                    })
                    .catch(error => console.error(`Lỗi khi tải ${filePath}:`, error));
            };
                        const updateCartCountInHeader = () => {
                                const user = JSON.parse(localStorage.getItem('user') || 'null');
                                let count = 0;
                                if (user && window.Cart?.getCart) {
                                    try { count = (Cart.getCart() || []).reduce((s, it) => s + Number(it.qty ?? it.quantity ?? 1), 0); } catch {}
                                }
                                const headerCount = document.getElementById('header-cart-count');
                                const offcanvasCount = document.getElementById('offcanvas-cart-count');
                                if (headerCount) headerCount.textContent = count;
                                if (offcanvasCount) offcanvasCount.textContent = count;
                        };
            const updateUserStatus = () => {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                const headerIn = document.getElementById('header-user-loggedin');
                const headerOut = document.getElementById('header-user-loggedout');
                const offIn = document.getElementById('user-menu-loggedin');
                const offOut = document.getElementById('user-menu-loggedout');
                if (user) {
                    if (headerIn && headerOut) {
                        headerIn.style.display = 'block';
                        headerOut.style.display = 'none';
                        const nameEl = document.getElementById('header-fullname-placeholder');
                        if (nameEl) nameEl.textContent = user.fullname;
                    }
                    if (offIn && offOut) {
                        offIn.style.display = 'block';
                        offOut.style.display = 'none';
                        const offName = document.getElementById('user-fullname-placeholder');
                        if (offName) offName.textContent = user.fullname;
                    }
                } else {
                    if (headerIn && headerOut) {
                        headerIn.style.display = 'none';
                        headerOut.style.display = 'block';
                    }
                    if (offIn && offOut) {
                        offIn.style.display = 'none';
                        offOut.style.display = 'block';
                    }
                }
            };

            // Khởi tạo UI sau khi chèn header/footer
            const initUI = () => {
                if ($.fn.slicknav && $(".mobile-menu").length && !$("#mobile-menu-wrap .slicknav_menu").length) {
                    $(".mobile-menu").slicknav({ prependTo: '#mobile-menu-wrap', allowParentLinks: true });
                }
                $(".canvas__open").off('click').on('click', function () { $(".offcanvas-menu-wrapper").addClass("active"); $(".offcanvas-menu-overlay").addClass("active"); });
                $(".offcanvas-menu-overlay").off('click').on('click', function () { $(".offcanvas-menu-wrapper").removeClass("active"); $(".offcanvas-menu-overlay").removeClass("active"); });
                $(".search-switch").off('click').on('click', function () { $(".search-model").fadeIn(400); });
                $(".search-close-switch").off('click').on('click', function () { $(".search-model").fadeOut(400, function () { $('#search-input').val(''); }); });
                $('.set-bg').each(function () { var bg = $(this).data('setbg'); $(this).css('background-image', 'url(' + bg + ')'); });
                updateCartCountInHeader();
                updateUserStatus();
            };

            // --- LOGIC RIÊNG CỦA TRANG LOẠI SẢN PHẨM ---
            let allProducts = [];
            const itemsPerPage = 6; // đổi 6 sản phẩm / trang

            async function initCategoryPage() {
                const params = new URLSearchParams(window.location.search);
                const categoryId = params.get('id');
                const currentPage = parseInt(params.get('page')) || 1;
                
                if (!categoryId) {
                    document.getElementById('product-grid').innerHTML = '<div class="col-12"><p class="text-danger">Không tìm thấy loại sản phẩm.</p></div>';
                    return;
                }

                try {
                    const response = await fetch('database/product.json');
                    allProducts = await response.json();
                    
                    // Lọc sản phẩm theo categoryId từ URL
                    const categoryProducts = allProducts.filter(p => p.CategoryId == categoryId);
                    
                    if (categoryProducts.length === 0) {
                        document.getElementById('product-grid').innerHTML = `<div class="col-12"><p>Loại sản phẩm này hiện chưa có bánh.</p></div>`;
                        return;
                    }

                    // Cập nhật tiêu đề và breadcrumb
                    const categoryName = categoryProducts[0].CategoryName;
                    document.title = `Loại bánh: ${categoryName}`;
                    document.getElementById('category-title').textContent = categoryName;
                    document.getElementById('breadcrumb-category-name').textContent = categoryName;

                    // Hiển thị sản phẩm và phân trang
                    renderProducts(categoryProducts, currentPage);
                    renderPagination(categoryId, categoryProducts.length, currentPage);
                    renderCategorySelector(categoryId);

                } catch (error) {
                    console.error("Lỗi khi tải dữ liệu:", error);
                }
            }

            function renderProducts(products, page) {
                const productGrid = document.getElementById('product-grid');
                productGrid.innerHTML = '';
                const startIndex = (page - 1) * itemsPerPage;
                const paginatedProducts = products.slice(startIndex, startIndex + itemsPerPage);

                paginatedProducts.forEach(product => {
                    productGrid.innerHTML += `
                        <div class="col-lg-4 col-md-6 col-sm-6">
                            <div class="product__item">
                                <div class="product__item__pic set-bg" style="background-image: url('${product.Image}')"></div>
                                <div class="product__item__text">
                                    <h6><a href="product_detail.html?id=${product.ProductId}">${product.Name}</a></h6>
                                    <h5>${product.SellPrice.toLocaleString('vi-VN')} VND</h5>
                                    <div>
                                        ${product.Avaiable_quantity > 0 
                                            ? `<button class="btn primary-btn btn-sm mt-2" onclick="handleAddToCart(${product.ProductId})">Thêm giỏ hàng</button>`
                                            : '<span style="color: red; font-weight: bold;">Hết hàng</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            function renderPagination(catId, totalItems, currentPage) {
                const paginationContainer = document.getElementById('pagination-container');
                paginationContainer.innerHTML = '';
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (totalPages <= 1) return;

                for (let i = 1; i <= totalPages; i++) {
                    paginationContainer.innerHTML += `<a href="list_product_by_category.html?id=${catId}&page=${i}" class="${i === currentPage ? 'active' : ''}">${i}</a>`;
                }
            }
            
            function renderCategorySelector(currentCatId) {
                const selector = document.getElementById('category-selector');
                const categories = [...new Map(allProducts.map(p => [p.CategoryId, p.CategoryName])).values()];
                
                categories.forEach((name, index) => {
                    const catId = [...new Map(allProducts.map(p => [p.CategoryId, p.CategoryName])).keys()][index];
                    selector.innerHTML += `<option value="${catId}" ${catId == currentCatId ? 'selected' : ''}>${name}</option>`;
                });
                
                selector.addEventListener('change', (e) => {
                    window.location.href = `list_product_by_category.html?id=${e.target.value}`;
                });
            }

            // --- KHỞI TẠO ---
            let loaded = 0; const afterInclude = () => { loaded++; if (loaded === 2) initUI(); };
            includeHTML('header-placeholder', 'inc/header.html', afterInclude);
            includeHTML('footer-placeholder', 'inc/footer.html', afterInclude);

            initCategoryPage();
            
            window.addEventListener('cartUpdated', updateCartCountInHeader);
        });
    </script>
</body>
</html>
