<!-- Offcanvas (mobile) -->
<div class="offcanvas-menu-overlay"></div>
<div class="offcanvas-menu-wrapper">
  <div class="offcanvas__cart">
    <div class="offcanvas__cart__links">
      <a href="#" class="search-switch"><img src="img/icon/search.png" alt="Tìm kiếm" /></a>
    </div>
    <div class="offcanvas__cart__item">
      <a href="view_cart.html"><img src="img/icon/cart.png" alt="Giỏ hàng" /> <span id="offcanvas-cart-count">0</span></a>
    </div>
  </div>
  <div class="offcanvas__logo">
    <a href="index.html"><img src="img/logo.png" alt="Logo" /></a>
  </div>
  <div id="mobile-menu-wrap"></div>
  <div class="offcanvas__option">
    <ul>
      <li id="user-menu-loggedout"><a href="login.html">Đăng nhập</a> / <a href="register.html">Đăng ký</a></li>
      <li id="user-menu-loggedin" style="display:none">
        <span id="user-fullname-placeholder"></span>
        <a href="#" data-logout class="ms-2">Đăng xuất</a>
      </li>
    </ul>
  </div>
</div>
<!-- Offcanvas End -->

<!-- Header -->
<header class="header">
  <!-- Top (nền trắng): logo + tài khoản + giỏ -->
  <div class="header__topline">
    <div class="container">
      <div class="row align-items-center" style="padding: 12px 0;">
        <div class="col-lg-3 col-6">
          <div class="header__logo">
            <a href="index.html"><img src="img/logo.png" alt="Cake" /></a>
          </div>
        </div>
        <div class="col-lg-9 col-6">
          <div class="account-cart">
            <!-- KHU VỰC USER: trạng thái ĐÃ đăng nhập -->
            <div id="header-user-loggedin" style="display:none;">
              <details class="user-dropdown">
                <summary class="user-trigger" aria-label="Tài khoản">
                  <i class="fa fa-user"></i>
                  <span id="header-fullname-placeholder" class="ml-1">Tài khoản</span>
                  <i class="fa fa-caret-down ml-1"></i>
                </summary>
                <div class="user-menu">
                  <a href="account.html"><i class="fa fa-id-card-o mr-2"></i> Thông tin tài khoản</a>
                  <a href="history_order.html"><i class="fa fa-list-alt mr-2"></i> Lịch sử mua hàng</a>
                  <a href="#" data-logout><i class="fa fa-sign-out mr-2"></i> Đăng xuất</a>
                </div>
              </details>

              <!-- Giỏ hàng -->
              <a href="view_cart.html" class="header__cart ml-3" title="Giỏ hàng">
                <i class="fa fa-shopping-bag"></i>
                <span id="header-cart-count">0</span>
              </a>
            </div>

            <!-- KHU VỰC USER: trạng thái CHƯA đăng nhập (giữ nguyên Đăng nhập/Đăng ký) -->
            <div id="header-user-loggedout" style="display:inline;">
              <a href="login.html"><i class="fa fa-user"></i> Đăng nhập</a>
              <span style="opacity:.6; margin: 0 6px">/</span>
              <a href="register.html"><i class="fa fa-user-plus"></i> Đăng ký</a>
            </div>
          </div>
        </div>
      </div>
      <div class="canvas__open"><i class="fa fa-bars"></i></div>
    </div>
  </div>

  <!-- Thanh menu cam (chỉ thanh điều hướng) -->
  <div class="header__menu__bar">
    <div class="container">
      <nav class="header__menu mobile-menu">
        <ul>
          <li><a href="index.html">Trang chủ</a></li>
          <li><a href="list_product.html">Cửa hàng</a></li>
          <li><a href="contact_add.html">Liên hệ</a></li>
        </ul>
      </nav>
  <!-- Tránh trùng id với offcanvas phía trên -->
  <div id="mobile-menu-wrap-2"></div>
    </div>
  </div>
</header>

<style>
  /* Tách nền: top trắng, menu cam */
  .header__topline { background: #fff; }
  .header__menu__bar { background: #f08632; }
  /* Bảo đảm dropdown nằm trên thanh menu cam */
  .header__topline { position: relative; z-index: 2000; }
  /* Căn phải và giãn cách giữa tài khoản và giỏ */
  .account-cart { display: flex; justify-content: flex-end; align-items: center; gap: 16px; }
  /* Bỏ dấu/chấm/đường kẻ quanh icon giỏ */
  .header__cart ul { margin: 0; padding: 0; list-style: none; }
  .header__cart ul li::after { display: none !important; }
  /* Dropdown dùng <details> để không phụ thuộc JS */
  details.user-dropdown { position: relative; display: inline-block; z-index: 4000; }
  .user-trigger { list-style: none; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
  .user-trigger::-webkit-details-marker { display: none; }
  .user-dropdown .user-menu { position: absolute; top: 100%; right: 0; min-width: 220px; background: #fff; border: 1px solid #e5e5e5; border-radius: 4px; box-shadow: 0 8px 24px rgba(0,0,0,.12); padding: 6px 0; display: none; z-index: 3000; }
  /* Mở bằng click (native <details>), tự ẩn khi chuột rời khỏi khu vực */
  .user-dropdown[open] .user-menu { display: block; }
  .user-dropdown[open]:not(:hover) .user-menu { display: none; }
  .user-dropdown .user-menu a { display: block; padding: 10px 14px; color: #333; text-decoration: none; white-space: nowrap; }
  .user-dropdown .user-menu a:hover { background: #f7f7f7; }

  /* Màu thương hiệu cho icon người và giỏ hàng ở header */
  .account-cart .fa-user,
  .account-cart .fa-caret-down,
  .account-cart .fa-shopping-bag,
  .account-cart .header__cart,
  .account-cart .header__cart #header-cart-count { color: #f08632 !important; }
  .account-cart .header__cart:hover { color: #da792d !important; }
  /* Màu cam cho icon Đăng nhập / Đăng ký ở trạng thái chưa đăng nhập */
  #header-user-loggedout .fa-user,
  #header-user-loggedout .fa-user-plus { color:#f08632 !important; }
  #header-user-loggedout a:hover .fa-user,
  #header-user-loggedout a:hover .fa-user-plus { color:#da792d !important; }
  /* Căn logo trắng thẳng hàng mép trên & cách đều khung cam */
  .header__topline .row { padding: 6px 0 6px; align-items: center; }
  .header__logo { display:flex; align-items:center; }
  .header__logo img { display:block; height:52px; width:auto; object-fit:contain; }
  /* Đảm bảo không chồng lấn lên thanh cam */
  .header__menu__bar { position:relative; z-index:1500; }
  /* Nếu image có nền trắng không đều, thêm viền để cảm giác cân đối */
  .header__logo img { box-shadow:0 0 0 1px #fff; }
  @media (max-width: 576px){
    .header__logo img { height:46px; }
  }
</style>

<script>
  (function () {
    function updateHeader() {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      const inEl = document.getElementById('header-user-loggedin');
      const outEl = document.getElementById('header-user-loggedout');
      const offIn = document.getElementById('user-menu-loggedin');
      const offOut = document.getElementById('user-menu-loggedout');
      const name1 = document.getElementById('header-fullname-placeholder');
      const name2 = document.getElementById('user-fullname-placeholder');
  // menu-history đã bị xoá khỏi nav, không cần xử lý nữa

      if (user) {
        if (inEl) inEl.style.display = 'inline-flex';
        if (outEl) outEl.style.display = 'none';
        if (offIn) offIn.style.display = '';
        if (offOut) offOut.style.display = 'none';
        if (name1) name1.textContent = user.fullname || user.email || 'Tài khoản';
        if (name2) name2.textContent = user.fullname || user.email || 'Tài khoản';
  // no-op
      } else {
        if (inEl) inEl.style.display = 'none';
        if (outEl) outEl.style.display = 'inline';
        if (offIn) offIn.style.display = 'none';
        if (offOut) offOut.style.display = '';
  // no-op
      }

      // Chỉ hiển thị số lượng giỏ của tài khoản đã đăng nhập (tổng số lượng, không phải số dòng)
      let count = 0;
      try {
        if (user && window.Cart?.getCart) {
          const items = Cart.getCart() || [];
          count = items.reduce((s, it) => s + Number(it.qty ?? it.quantity ?? 1), 0);
        }
      } catch {}
      const headCount = document.getElementById('header-cart-count');
      const offCount = document.getElementById('offcanvas-cart-count');
      if (headCount) headCount.textContent = count;
      if (offCount) offCount.textContent = count;
    }

    // Lưu ý: Xử lý logout tập trung ở IIFE phía dưới để tránh trùng lặp

    document.addEventListener('DOMContentLoaded', updateHeader);
    window.addEventListener('authChanged', updateHeader);
    window.addEventListener('cartUpdated', updateHeader);
  })();

  // Hỗ trợ phím Esc để đóng dropdown; Logout đã được xử lý tập trung trong js/auth.js
  (function(){
    document.addEventListener('keydown', (e)=>{
      if (e.key !== 'Escape') return;
      const d = document.querySelector('details.user-dropdown[open]');
      if (d) d.removeAttribute('open');
    });
  })();
</script>