<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Cake Template">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa Hàng Bánh</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- CSS Styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="css/flaticon.css" type="text/css">
    <link rel="stylesheet" href="css/barfiller.css" type="text/css">
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">
</head>
<body>
    <!-- Header sẽ được tải vào đây -->
    <div id="header-placeholder"></div>

    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="breadcrumb__text">
                        <h2>Cửa Hàng</h2>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="breadcrumb__links">
                        <a href="./index.html">Trang chủ</a>
                        <span>Cửa Hàng</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Shop Section Begin -->
    <section class="shop spad">
        <div class="container">
            <div class="shop__option">
                <div class="row">
                    <!-- BỘ LỌC VÀ TÌM KIẾM -->
                    <div class="col-lg-7 col-md-7">
                        <div class="shop__option__search d-flex flex-wrap align-items-start gap-2" style="gap:8px">
                            <select id="category-filter" class="custom-select" style="width:auto;"></select>
                            <input type="text" id="search-input" class="form-control" style="max-width:200px" placeholder="Tên sản phẩm...">
                            <!-- Bộ lọc giá nâng cao -->
                            <input type="number" id="min-price" class="form-control" style="max-width:130px" placeholder="Giá từ" min="0" step="1000">
                            <input type="number" id="max-price" class="form-control" style="max-width:130px" placeholder="Đến" min="0" step="1000">
                            <button id="reset-filters" class="btn btn-sm btn-outline-secondary" type="button">Xóa</button>
                        </div>
                    </div>
                    <!-- SẮP XẾP -->
                    <div class="col-lg-5 col-md-5">
                        <div class="shop__option__right">
                            <select id="sort-filter" class="custom-select">
                                <option value="">Sắp xếp mặc định</option>
                                <option value="low_to_high">Giá: Thấp đến Cao</option>
                                <option value="high_to_low">Giá: Cao đến Thấp</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- KHUNG LƯỚI HIỂN THỊ SẢN PHẨM -->
            <div class="row" id="product-grid">
                <!-- Sản phẩm sẽ được chèn vào đây bằng JavaScript -->
            </div>
            <!-- KHU VỰC PHÂN TRANG -->
            <div class="shop__last__option">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="shop__pagination" id="pagination-container">
                            <!-- Các nút phân trang sẽ được chèn vào đây -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Shop Section End -->

    <!-- Footer sẽ được tải vào đây -->
    <div id="footer-placeholder"></div>

    <!-- JS -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/jquery.nicescroll.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.barfiller.js"></script>
    <script src="js/main.js"></script>
    <script src="js/cart.js"></script> 

    <!-- TOÀN BỘ LOGIC CỦA TRANG ĐƯỢC ĐẶT Ở ĐÂY -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            // 1. Hàm tải các thành phần HTML (Header/Footer)
            const includeHTML = (elementId, filePath, callback) => {
                fetch(filePath)
                    .then(response => response.ok ? response.text() : Promise.reject('File not found'))
                    .then(data => {
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.innerHTML = data;
                            if (callback) callback();
                        }
                    })
                    .catch(error => console.error(`Lỗi khi tải ${filePath}:`, error));
            };

            // 2. Hàm cập nhật số lượng giỏ hàng trên Header
                        const updateCartCountInHeader = () => {
                                const user = JSON.parse(localStorage.getItem('user') || 'null');
                                let count = 0;
                                if (user && window.Cart?.getCart) {
                                    try { count = (Cart.getCart() || []).reduce((s, it) => s + Number(it.qty ?? it.quantity ?? 1), 0); } catch {}
                                }
                                const headerCount = document.getElementById('header-cart-count');
                                const offcanvasCount = document.getElementById('offcanvas-cart-count');
                                if (headerCount) headerCount.textContent = count;
                                if (offcanvasCount) offcanvasCount.textContent = count;
                        };

            // 3. Hàm cập nhật trạng thái đăng nhập trên Header
            const updateUserStatus = () => {
                const user = JSON.parse(localStorage.getItem("user") || "null");
                const headerIn = document.getElementById('header-user-loggedin');
                const headerOut = document.getElementById('header-user-loggedout');
                const offIn = document.getElementById('user-menu-loggedin');
                const offOut = document.getElementById('user-menu-loggedout');
                if (user) {
                    if (headerIn && headerOut) {
                        headerIn.style.display = 'block';
                        headerOut.style.display = 'none';
                        const nameEl = document.getElementById('header-fullname-placeholder');
                        if (nameEl) nameEl.textContent = user.fullname;
                    }
                    if (offIn && offOut) {
                        offIn.style.display = 'block';
                        offOut.style.display = 'none';
                        const offName = document.getElementById('user-fullname-placeholder');
                        if (offName) offName.textContent = user.fullname;
                    }
                } else {
                    if (headerIn && headerOut) {
                        headerIn.style.display = 'none';
                        headerOut.style.display = 'block';
                    }
                    if (offIn && offOut) {
                        offIn.style.display = 'none';
                        offOut.style.display = 'block';
                    }
                }
            };

            // Init UI after header/footer are injected
            const initUI = () => {
                if ($.fn.slicknav && $(".mobile-menu").length && !$("#mobile-menu-wrap .slicknav_menu").length) {
                    $(".mobile-menu").slicknav({ prependTo: '#mobile-menu-wrap', allowParentLinks: true });
                }
                $(".canvas__open").off('click').on('click', function () { $(".offcanvas-menu-wrapper").addClass("active"); $(".offcanvas-menu-overlay").addClass("active"); });
                $(".offcanvas-menu-overlay").off('click').on('click', function () { $(".offcanvas-menu-wrapper").removeClass("active"); $(".offcanvas-menu-overlay").removeClass("active"); });
                $(".search-switch").off('click').on('click', function () { $(".search-model").fadeIn(400); });
                $(".search-close-switch").off('click').on('click', function () { $(".search-model").fadeOut(400, function () { $('#search-input').val(''); }); });
                $('.set-bg').each(function () { var bg = $(this).data('setbg'); $(this).css('background-image', 'url(' + bg + ')'); });
                updateCartCountInHeader();
                updateUserStatus();
            };

            // --- LOGIC RIÊNG CỦA TRANG CỬA HÀNG ---
            
            let allProducts = [];
            
            const state = {
                searchTerm: '',
                sortOrder: '',
                categoryId: '',
                minPrice: '',
                maxPrice: '',
                currentPage: 1,
                itemsPerPage: 6 // đồng bộ 6 sản phẩm / trang
            };

            async function fetchData() {
                try {
                    const response = await fetch('database/product.json');
                    allProducts = await response.json();
                } catch (error) {
                    console.error("Lỗi khi tải dữ liệu sản phẩm:", error);
                    document.getElementById('product-grid').innerHTML = '<p class="text-danger">Không thể tải sản phẩm.</p>';
                }
            }

            function renderProducts() {
                const productGrid = document.getElementById('product-grid');
                productGrid.innerHTML = '';
                let filteredProducts = [...allProducts];

                if (state.categoryId) {
                    filteredProducts = filteredProducts.filter(p => p.CategoryId == state.categoryId);
                }
                if (state.searchTerm) {
                    filteredProducts = filteredProducts.filter(p => p.Name.toLowerCase().includes(state.searchTerm.toLowerCase()));
                }
                // Lọc nâng cao theo giá
                const min = state.minPrice !== '' ? Number(state.minPrice) : null;
                const max = state.maxPrice !== '' ? Number(state.maxPrice) : null;
                if (min != null && !isNaN(min)) {
                    filteredProducts = filteredProducts.filter(p => p.SellPrice >= min);
                }
                if (max != null && !isNaN(max)) {
                    filteredProducts = filteredProducts.filter(p => p.SellPrice <= max);
                }
                // Nếu cả min & max có và min > max: không kết quả
                if (min != null && max != null && min > max) {
                    filteredProducts = [];
                }
                if (state.sortOrder === 'low_to_high') {
                    filteredProducts.sort((a, b) => a.SellPrice - b.SellPrice);
                } else if (state.sortOrder === 'high_to_low') {
                    filteredProducts.sort((a, b) => b.SellPrice - a.SellPrice);
                }

                const totalFilteredProducts = filteredProducts.length;
                const startIndex = (state.currentPage - 1) * state.itemsPerPage;
                const paginatedProducts = filteredProducts.slice(startIndex, startIndex + state.itemsPerPage);

                if (paginatedProducts.length === 0) {
                    const conds = [];
                    if (state.searchTerm) conds.push(`tên chứa "${state.searchTerm}"`);
                    if (state.categoryId) {
                        const catName = allProducts.find(p => p.CategoryId == state.categoryId)?.CategoryName || 'loại đã chọn';
                        conds.push(`thuộc loại "${catName}"`);
                    }
                    if (state.minPrice !== '') conds.push(`giá ≥ ${Number(state.minPrice).toLocaleString('vi-VN')} VND`);
                    if (state.maxPrice !== '') conds.push(`giá ≤ ${Number(state.maxPrice).toLocaleString('vi-VN')} VND`);
                    productGrid.innerHTML = `<div class="col-12"><p>Không tìm thấy sản phẩm nào ${conds.length ? 'phù hợp với: ' + conds.join(', ') : 'phù hợp'}.</p></div>`;
                } else {
                    paginatedProducts.forEach(product => {
                        const productHTML = `
                            <div class="col-lg-4 col-md-6 col-sm-6">
                                <div class="product__item">
                                    <div class="product__item__pic" style="background-image: url('${product.Image}')"></div>
                                    <div class="product__item__text">
                                        <h6><a href="product_detail.html?id=${product.ProductId}">${product.Name}</a></h6>
                                        <h5>${product.SellPrice.toLocaleString('vi-VN')} VND</h5>
                                        <div>
                                            ${product.Avaiable_quantity > 0 
                                                ? `<button class="btn primary-btn mt-4" onclick="handleAddToCart(${product.ProductId})">Thêm giỏ hàng</button>`
                                                : '<span style="color: red; font-weight: bold;">Hết hàng</span>'
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        productGrid.insertAdjacentHTML('beforeend', productHTML);
                    });
                }
                renderPagination(totalFilteredProducts);
            }

            function renderPagination(totalItems) {
                const paginationContainer = document.getElementById('pagination-container');
                paginationContainer.innerHTML = '';
                const totalPages = Math.ceil(totalItems / state.itemsPerPage);
                if (totalPages <= 1) return;

                // Nút "Trước"
                if(state.currentPage > 1) {
                    paginationContainer.innerHTML += `<a href="#" data-page="${state.currentPage - 1}"><span class="arrow_carrot-left"></span></a>`;
                }

                for (let i = 1; i <= totalPages; i++) {
                    paginationContainer.innerHTML += `<a href="#" data-page="${i}" class="${i === state.currentPage ? 'active' : ''}">${i}</a>`;
                }

                // Nút "Sau"
                if(state.currentPage < totalPages) {
                     paginationContainer.innerHTML += `<a href="#" data-page="${state.currentPage + 1}"><span class="arrow_carrot-right"></span></a>`;
                }
            }

            function renderCategories() {
                const categoryFilter = document.getElementById('category-filter');
                const categories = [...new Map(allProducts.map(p => [p.CategoryId, {id: p.CategoryId, name: p.CategoryName}])).values()];
                
                categoryFilter.innerHTML = '<option value="">Tất cả loại bánh</option>';
                categories.sort((a, b) => a.name.localeCompare(b.name)).forEach(cat => {
                    categoryFilter.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            }

            function attachEventListeners() {
                document.getElementById('search-input').addEventListener('input', e => {
                    state.searchTerm = e.target.value;
                    state.currentPage = 1;
                    renderProducts();
                });
                document.getElementById('sort-filter').addEventListener('change', e => {
                    state.sortOrder = e.target.value;
                    state.currentPage = 1;
                    renderProducts();
                });
                document.getElementById('category-filter').addEventListener('change', e => {
                    state.categoryId = e.target.value;
                    state.currentPage = 1;
                    renderProducts();
                });
                document.getElementById('min-price').addEventListener('input', e => {
                    state.minPrice = e.target.value;
                    state.currentPage = 1;
                    renderProducts();
                });
                document.getElementById('max-price').addEventListener('input', e => {
                    state.maxPrice = e.target.value;
                    state.currentPage = 1;
                    renderProducts();
                });
                document.getElementById('reset-filters').addEventListener('click', () => {
                    state.searchTerm = '';
                    state.sortOrder = '';
                    state.categoryId = '';
                    state.minPrice = '';
                    state.maxPrice = '';
                    state.currentPage = 1;
                    document.getElementById('search-input').value = '';
                    document.getElementById('sort-filter').value = '';
                    document.getElementById('category-filter').value = '';
                    document.getElementById('min-price').value = '';
                    document.getElementById('max-price').value = '';
                    renderProducts();
                });
                document.getElementById('pagination-container').addEventListener('click', e => {
                    e.preventDefault();
                    const target = e.target.closest('a');
                    if (target && target.dataset.page) {
                        state.currentPage = parseInt(target.dataset.page);
                        renderProducts();
                        window.scrollTo(0, 0); // Cuộn lên đầu trang khi chuyển trang
                    }
                });
            }

            // --- KHỞI TẠO VÀ CHẠY CHƯƠNG TRÌNH ---
            
            // Tải Header/Footer và cập nhật trạng thái
            let loaded = 0; const afterInclude = () => { loaded++; if (loaded === 2) initUI(); };
            includeHTML('header-placeholder', 'inc/header.html', afterInclude);
            includeHTML('footer-placeholder', 'inc/footer.html', afterInclude);

            // Bắt đầu logic của trang cửa hàng
            await fetchData();
            renderCategories();
            renderProducts();
            attachEventListeners();

            // Luôn lắng nghe sự kiện giỏ hàng để cập nhật header
            window.addEventListener('cartUpdated', updateCartCountInHeader);
        });
    </script>
</body>
</html>

